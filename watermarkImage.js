function DealImage({target,image,mosaicSize=20}){this.canvas=document.querySelector(target);this._canvas=document.createElement("canvas");if(!this.canvas&&this.canvas.getContext)return false;if(!image)throw new Error("缺少图片url");this.opt={image:image,mosaicSize:mosaicSize,ctx:this.canvas.getContext('2d'),_ctx:this._canvas.getContext('2d'),fileName:this.getFileName(image)}}DealImage.prototype={constructor:DealImage,draw:function(_opt){var img=new Image(),self=this;img.onload=function(){self.getImageData(img);if(_opt.mosaic)self.drawMosaic(_opt.mosaic);if(_opt.frame)self.drawFrame(_opt.frame);self.opt.ctx.drawImage(self._canvas,0,0);if(self.url&&typeof self.opt.image==="object"){URL.revokeObjectURL(self.url)}if(typeof _opt.callback=="function"){let imgBase64=self.canvas.toDataURL(_opt.type);_opt.callback(imgBase64,self.opt.fileName)}};img.crossOrigin='';if(typeof this.opt.image==="string"){img.src=this.opt.image}else{this.url=URL.createObjectURL(this.opt.image);img.src=this.url}},drawMosaic(_opt){if(!this.isJson(_opt.position))throw new TypeError("参数必须是json数组对象");var r,g,b,color,self=this;_opt.position.forEach(function(item,index){if(!self.isObject(item))return false;for(let y=item.start[1];y<item.end[1];y+=self.opt.mosaicSize){for(let x=item.start[0];x<item.end[0];x+=self.opt.mosaicSize){r=self.imageData[(y*self._canvas.width+x)*4];g=self.imageData[(y*self._canvas.width+x)*4+1];b=self.imageData[(y*self._canvas.width+x)*4+2];color=`rgb(${r},${g},${b})`;self.opt._ctx.fillStyle=color;self.opt._ctx.fillRect(x,y,self.opt.mosaicSize,self.opt.mosaicSize)}}})},drawFrame:function(_opt){if(!this.isJson(_opt.position))throw new TypeError("参数必须是json数组对象");var self=this;_opt.position.forEach(function(item,index){if(!self.isObject(item))return false;self.opt._ctx.beginPath();self.opt._ctx.moveTo(item.start[0],item.start[1]);self.opt._ctx.lineTo(item.start[0],item.end[1]);self.opt._ctx.lineTo(item.end[0],item.end[1]);self.opt._ctx.lineTo(item.end[0],item.start[1]);self.opt._ctx.lineTo(item.start[0],item.start[1]);self.opt._ctx.strokeStyle=_opt.color;self.opt._ctx.stroke()})},isObject:function(obj){return Object.prototype.toString.call(obj)==="[object Object]"},isJson:function(option){if(!(option instanceof Array))return false;var self=this,temp=[];option.forEach((item,index)=>{temp.push(self.isObject(item))});return temp.length>0&&!temp.includes(false)},getFileName:function(image){let filename;if(typeof image=="string"){let tempArr=image.split("/");filename=tempArr[tempArr.length-1].split(".")[0]}else{filename=image.name.split(".")[0]}return filename},getImageData:function(img){this.canvas.width=img.width;this.canvas.height=img.height;this._canvas.width=img.width;this._canvas.height=img.height;this.opt._ctx.drawImage(img,0,0);this.imageData=this.opt._ctx.getImageData(0,0,this._canvas.width,this._canvas.height).data}}